# アプリケーション構築・設定ガイド

本ドキュメントは、Rust (Axum) + Vue (Vite) 構成のアプリケーションをビルド・設定する際の技術的な知見とベストプラクティスをまとめたものです。
Cloud Run などのコンテナ環境での運用を想定しています。

## 1. バックエンド (Rust / Axum)

### Cloud Run / コンテナ対応

Cloud Run などのプラットフォームで安全かつ確実に動作させるために、以下の対応を行っています。

1. **グレースフルシャットダウンの実装**
    * Cloud Run はコンテナ停止時に `SIGTERM` シグナルを送信します。
    * これを検知して、処理中のリクエストが完了するまで待機してからプロセスを終了する必要があります。
    * 実装: `tokio::signal::unix::SignalKind::terminate()` を監視し、`axum::serve(...).with_graceful_shutdown(...)`
      に接続します。
    * **注意点**: `axum::serve(...)` の直後に `.await` せず、まず `.with_graceful_shutdown()` をチェーンさせること（順序が重要）。

2. **静的ファイルパスの動的解決**
    * `env!("CARGO_MANIFEST_DIR")` はビルド時のパスを埋め込むため、コンテナ環境では使用できません。
    * 実行時には以下の優先順位でディレクトリを解決するように実装します。
        1. 環境変数 `PUBLIC_DIR`
        2. カレントディレクトリ配下の `public` (`./public`)
    * Dockerfile 内で `ENV PUBLIC_DIR=/app/public` のように明示することで、確実にパスを制御できます。

3. **ヘルスチェック**
    * `/healthz` エンドポイントを用意し、デプロイメント時の起動確認に使用します。

### リリースビルド最適化

コンテナサイズ削減と起動高速化のため、`Cargo.toml` に以下の設定を追加しています。

## 2. フロントエンド (Vue / Vite)

### 静的アセットの配信とキャッシュ

Vite ビルドは `dist/assets/` 配下にハッシュ付きのファイル（例: `index-D4NEoGLr.js`）を生成します。

* **キャッシュの挙動**:
    * ファイル名にハッシュが含まれるため、コンテンツが変わればファイル名も変わります。
    * ブラウザが古い `index.html` をキャッシュしていると、古いハッシュ名の JS/CSS を要求し、サーバー上にそのファイルが存在しないため
      `404 Not Found` になることがあります。
    * **開発・検証時の注意**: コンテナを再ビルドして差し替えた直後は、ブラウザのキャッシュをクリア（スーパーリロードやシークレットウィンドウ）して確認する必要があります。

## 3. Axum ルーティング設定のポイント

SPA（Single Page Application）と静的ファイルを共存させるためのルーティング構成です。

* **nest_service の活用 (Optional)**:
    * `/assets` などの静的リソースパスが明確な場合、`.nest_service("/assets", ServeDir::new(...))`
      のように明示的に定義することで、意図しないフォールバックを防ぎ、ルーティングを明確にできます。

## 4. 環境変数 (.env) の運用

* **開発環境**: `.env` ファイルを使用（`dotenvy` クレートで読み込み）。
* **コンテナ環境**: Dockerfile の `ENV` または Cloud Run の環境変数設定を使用。
* **重要な変数**:
    * `GITHUB_ACCESS_TOKEN`: 必須。アプリケーションのコア機能用。
    * `PORT`: Cloud Run が自動注入（デフォルト 8080）。
    * `PUBLIC_DIR`: 静的ファイルの配置場所（コンテナ内パス `/app/public` など）。
    * 